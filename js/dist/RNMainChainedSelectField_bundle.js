rndefine("#RNMainChainedSelectField",["#RNMainCore/EventManager","#RNMainCore/StoreBase","#RNMainFormBuilderCore/FieldWithPrice.Options","lit","#RNMainFormBuilderCore/FieldWithPrice.Model","#RNMainCore/Sanitizer","#RNMainCore/WpAjaxPost","lit/decorators","#RNMainFormBuilderCore/FieldBase","#RNMainFormBuilderCore/FieldWithPrice","lit/directives/repeat.js","#RNMainCore/LitElementBase","#RNMainLit/Lit","#RNMainFormBuilderCore/CalculatorBase"],(function(e,t,i,l,s,n,r,a,o,h,d,u,c,p){"use strict";var m,S,I,C,f,b,g,V;let y=(m=t.StoreAutoIncrement("chaineditem"),S=class extends t.StoreBase{constructor(...e){super(...e),babelHelpers.initializerDefineProperty(this,"Id",I,this),this.Index=0}LoadDefaultValues(){this.Id=0}},I=babelHelpers.applyDecoratedDescriptor(S.prototype,"Id",[m],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),S),O=(C=t.StoreDataType(y),f=t.StoreDataType(String),b=class extends i.FieldWithPriceOptions{constructor(...e){super(...e),babelHelpers.initializerDefineProperty(this,"Items",g,this),babelHelpers.initializerDefineProperty(this,"Columns",V,this),this.Alignment="v",this.Source="File"}LoadDefaultValues(){super.LoadDefaultValues(),this.Items=[],this.ReadOnly=!1,this.Type="chained",this.Columns=[],this.Alignment="h",this.Label="Chained Select",this.EmptyPlaceholder="Select an item",this.Source="File",this.SheetFileId="",this.SheetTabId="",this.UseLastColumnAsPrice=!1,this.SyncAutomatically=!1}},g=babelHelpers.applyDecoratedDescriptor(b.prototype,"Items",[C],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),V=babelHelpers.applyDecoratedDescriptor(b.prototype,"Columns",[f],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),b);class F{constructor(e){this.Model=e,this.Cache=new Map}async LoadOptions(e){let t=e.join("|");if(this.Cache.has(t))return this.Cache.get(t);let i=this.InternalLoadOptions(e);return this.Cache.set(t,i),i}async InternalLoadOptions(e){let t=await r.WpAjaxPost.Post("get_csv_items",{fieldId:this.Model.Options.Id,formId:this.Model.RootFormBuilder.FormId,ids:e,nonce:n.Sanitizer.GetValueFromPath(this.Model.RootFormBuilder.AdditionalOptions,["Extra","CSV",this.Model.Options.Id.toString(),"Nonce"],"")});if(null==t)return this.Cache.delete(e.join("|")),!1;let i=[];for(let e of t)i.push({Label:e.L,Price:e.P,Children:null});t=i;let l=this.Model.RootChainItems,s=null;for(let t of e){if(null==l)return!1;if(s=l.find((e=>e.Label==t)),null==s)return!1;l=s.Children}return null!=s&&(s.Children=t),this.Cache.delete(e.join("|")),!0}IsLoading(e){return this.Cache.has(e.join("|"))}}class L extends s.FieldWithPriceModel{constructor(e,t){super(e,t),this._text="",this.SelectedValues=[],this.OptionsLoader=new F(this),this.RootChainItems=[]}InternalSerialize(e){e.Value=this.GetValue()}get IsReadonly(){return!!this.Options.ReadOnly||super.IsReadonly}GetValue(){return this.GetIsVisible()?this.SelectedValues:""}GetNumber(){if(!this.GetIsUsed())return 0;let e=this.GetOptionByIds(this.SelectedValues);return n.Sanitizer.SanitizeNumber(n.Sanitizer.GetStringValueFromPath(e,["Price"],"0"))}GetIsUsed(){return!!super.GetIsUsed()&&!this.SelectedValues.some((e=>""==e))}render(){return l.html`<rn-chained-select-field .model="${this}"></rn-chained-select-field>`}GetText(){return this.GetIsUsed()?this.SelectedValues.join(" - "):""}InitializeStartingValues(e){let t=this.GetPreviousDataProperty("Value",[]);this.SelectedValues=new Array(this.Options.Columns.length),this.SelectedValues=this.SelectedValues.fill("");let i=n.Sanitizer.GetValueFromPath(this.RootFormBuilder.AdditionalOptions,["Extra","CSV",this.Options.Id.toString(),"Items"],[]);for(let e of i)this.RootChainItems.push({Label:e.L,Price:n.Sanitizer.SanitizeNumber(e.P,0),Children:null});t.length==this.SelectedValues.length&&this.SetSelection(t),this.FireValueChanged()}GetInputOptions(e){var t;return 0==e?this.RootChainItems:null===(t=this.GetOptionByIds(this.SelectedValues.slice(0,e)))||void 0===t?void 0:t.Children}GetOptionByIds(e){let t=null,i=this.RootChainItems;for(let l=0;l<e.length;l++){if(null==i)return null;let s=i.find((t=>t.Label==e[l]));if(null==s)return null;if(t=s,i=s.Children,l==e.length-1)return t;if(null==t)return null}return null}async SetInputSelection(e,t,i=!1){if(this.SelectedValues.length<=e)return!1;this.SelectedValues[e]=t;for(let t=e+1;t<this.SelectedValues.length;t++)this.SelectedValues[t]="";return this.SelectedValues.some((e=>""==e))||this.RemoveError("required"),this.FireValueChanged(),!i||await this.LoadOptions(this.SelectedValues.slice(0,e+1))}GetInputSelection(e){return this.SelectedValues.length<=e?"":this.SelectedValues[e]}IsDisabled(e){return 0!=e&&(""==this.SelectedValues[e-1]||null==this.GetInputOptions(e)||void 0)}async LoadOptions(e){var t;if(e.some((e=>""==e))||0==e.length)return!1;if(null!=(null===(t=this.GetOptionByIds(e))||void 0===t?void 0:t.Children))return!0;let i=this.SelectedValues.join("-");return await this.OptionsLoader.LoadOptions(e),i==this.SelectedValues.join("-")&&this.Refresh(),!0}async SetSelection(e){if(this.Options.Columns.length==e.length)for(let t=0;t<e.length;t++)if(!await this.SetInputSelection(t,e[t],!0))return}}var P;a.customElement("rn-chained-select-item")(class extends u.LitElementBase{render(){let e=this.model.GetInputSelection(this.index),t=this.model.IsDisabled(this.index),i=this.model.GetInputOptions(this.index),s=!1;if(null==i){let e=this.model.SelectedValues.slice(0,this.index);e.some((e=>""==e))||this.model.RootFormBuilder.IsDesign?i=[]:(this.model.OptionsLoader.IsLoading(e)||this.model.LoadOptions(e),s=!0)}return l.html` ${c.rnIf(s?l.html`<div style="width: 100%">Loading...</div>`:l.html` <select ?disabled="${t}" style="width: 100%" @change="${e=>this.OnChange(e)}" value="${e}"> <option value="">${this.model.Options.EmptyPlaceholder}</option> ${d.repeat(i,(e=>e.Label),(t=>l.html`<option ?selected="${t.Label==e}">${t.Label}</option>`))} </select>`)} <span>${this.item}</span> `}OnChange(e){this.model.SetInputSelection(this.index,e.target.value)}});let R=a.customElement("rn-chained-select-field")(P=class extends h.FieldWithPrice{static get properties(){return o.FieldBase.properties}SubRender(){return l.html` <div style="position: relative;" class="chaincontainer ${"v"==this.model.Options.Alignment?"vertical":"horizontal"}"> ${d.repeat(this.model.Options.Columns,((e,t)=>e+"_"+t),((e,t)=>l.html`<rn-chained-select-item .model="${this.model}" .item="${e}" .index="${t}"></rn-chained-select-item>`))} </div> `}})||P;class G extends p.CalculatorBase{ExecuteCalculation(e,t){let i=this.Field.GetOptionByIds(this.Field.SelectedValues),l=n.Sanitizer.SanitizeNumber(n.Sanitizer.GetStringValueFromPath(i,["Price"],"0"));return this.GetIsUsed()?{RegularPrice:l,Quantity:this.GetQuantity()}:{RegularPrice:"",Quantity:0}}}exports.ChainedSelectFieldModel=L,exports.ChainedSelectField=R,exports.ChainedSelectFieldOptions=O,e.EventManager.Subscribe("GetFieldOptions",(e=>{if("chained"==e)return new O})),e.EventManager.Subscribe("GetFieldModel",(e=>{if("chained"==e.Options.Type)return new L(e.Options,e.Parent)})),e.EventManager.Subscribe("GetCalculator",(e=>{if("chained_options"==e)return new G}))}));
