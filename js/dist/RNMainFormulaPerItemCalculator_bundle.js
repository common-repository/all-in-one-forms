rndefine("#RNMainFormulaPerItemCalculator",["exports","#RNMainFormBuilderCore/CalculatorBase","#RNMainCore/EventManager","#RNMainFormBuilderCore/OptionsCalculator"],(function(e,i,t,l){"use strict";class n extends i.CalculatorBase{constructor(){super(),this.OptionsCalculator=new l.OptionsCalculator}Initialize(e){super.Initialize(e);let i=this.Field.FormulaManager.GetFormula("Price");for(let e of i.Fields){let t=this.Field.FormBuilder.GetFieldById(e,!1,!0);if(null==t)return void alert(`Invalid formula for field ${this.Field.Options.Label+" (Id:"+this.Field.Options.Id}), field with id ${e} does not exist`);t.ValueChanged.Subscribe([this,i.Name],(e=>{this.ExecuteAndUpdate()}))}return this.OptionsCalculator.Initialize(e),this}ExecuteCalculation(e){let i=this.Field.FormulaManager.GetFormula("Price");this.Field.DisableFireValueChanged=!0;let l=this.Field.OptionItemsToUse.map((e=>this.Field.GetOptionPrice(e)));for(let e of this.Field.OptionItemsToUse){let l=t.EventManager.Publish("CalculateFormula",{Formula:i,Owner:this.Field.FormBuilder,Field:this.Field,Chain:null,CustomRetriever:(i,t,l)=>"current_option"==t?new r(this.Field,e.Id):null});this.Field.SetOptionPrice(e.Id,l)}this.Field.DisableFireValueChanged=!1;let n=this.Field.OptionItemsToUse.map((e=>this.Field.GetOptionPrice(e)));return l.join(",")!=n.join(",")&&this.Field.FireValueChanged(),this.OptionsCalculator.ExecuteCalculation(null)}}class r{constructor(e=null,i=null){this.Field=e,this.id=i}GetColumnValue(e){let i=this.Field.OptionItemsToUse.find((e=>e.Id==this.id));if(null==i)return null;let t=this.Field.Options.AdditionalOptionColumn.find((i=>i.Id==e||i.Label==e));if(null==t)return null;let l=i.AdditionalOptionValue.find((e=>e.Id==t.Id));return null==l?null:l.Value}toString(){let e=this.Field.OptionItemsToUse.find((e=>e.Id==this.id));return this.Field.GetOptionPrice(e,!0)}}t.EventManager.Subscribe("GetCalculator",(e=>{if("formula_item"==e)return new n})),e.FormulaPerItemCalculator=n,Object.defineProperty(e,"__esModule",{value:!0})}));
