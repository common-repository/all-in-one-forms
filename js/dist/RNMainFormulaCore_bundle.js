rndefine("#RNMainFormulaCore",["#RNMainCore/Sanitizer","#RNMainCore/EventManager","#RNMainFormBuilderCore/FormBuilder.Options","#RNMainFormBuilderCore/CalculatorBase"],(function(e,t,r,s){"use strict";class i{constructor(e,t){this.Options=e,this.Parent=t}get Retriever(){return this.Parent.Retriever}MaybeExecutePromise(e,t){return e instanceof Promise?new Promise((async(r,s)=>{try{let s=await e;r(t(s))}catch(e){s(e)}})):t(e)}Iterate(e,t,r){let s=(e,i)=>{if(e.length>i){let n=e[i].Parse();if(n instanceof Promise)return new Promise((async(s,a)=>{for(;;){if(n instanceof Promise)try{n=await n}catch(e){return void a(e)}let u=!1;if(t(n,i,(()=>{u=!0,s(r())})),u)return;if(i+1==e.length)return void s(r());i++,n=e[i].Parse()}}));{let a=!1;return t(n,i,(()=>{a=!0})),a?r():s(e,i+1)}}return r()};return s(e,0)}get Type(){return this.Options.T}}class n{static GetFRElement(e,t){if(null==n.FieldDictionary[e.T])throw new Error("Formula element was not found "+e.T);return new n.FieldDictionary[e.T](e,t)}static AddField(e,t){n.FieldDictionary[e]=t}}n.FieldDictionary={};class a{static UnixToDate(e,t=0){if(null!=e){let r=new Date(1e3*(e+t));return r=new Date(r.setMinutes(r.getMinutes()+r.getTimezoneOffset())),r}return null}static DateToUnix(e,t=0){return(e.getTime()-t)/1e3+-1*e.getTimezoneOffset()*60}}class u extends i{constructor(e,t,r=null){super(e,null),this.ShouldReturn=!1,this.Sentences=[],this._retriever=t,Array.isArray(null==e?void 0:e.d)&&e.d.forEach((e=>{this.Sentences.push(n.GetFRElement(e,this))}))}get Retriever(){return this._retriever}InternalParse(){let e=null;return this.Iterate(this.Sentences,((t,r,s)=>{e=t,this.ShouldReturn&&s()}),(()=>e))}ParsePrice(){return this.MaybeExecutePromise(this.Parse(),(t=>e.Sanitizer.SanitizeNumber(t)))}ParseNumber(){return this.MaybeExecutePromise(this.Parse("Num"),(t=>e.Sanitizer.SanitizeNumber(t)))}GetType(){return"Main"}ReturnWasExecuted(){this.ShouldReturn=!0}Parse(t=null){return this.MaybeExecutePromise(this.InternalParse(),(r=>(null==r?void 0:r.IsField)?(Array.isArray(r)&&r.reduce(((e,t)=>t.GetNumber()+e),0),"Num"==t?r.GetNumber():"Str"==t?r.GetText():r.GetPrice()):Array.isArray(r)?r.map((t=>e.Sanitizer.SanitizeString(t))).join(", "):null==r?null:r instanceof Date?"Num"==t?a.DateToUnix(r):r.toString():["boolean","string","number"].indexOf(typeof r)>=0?r:r.toString()))}ParseString(){return this.MaybeExecutePromise(this.Parse("Str"),(t=>e.Sanitizer.SanitizeString(t)))}ParseRaw(){return this.InternalParse()}}class o extends i{constructor(e,t){super(e,t)}Parse(){let e=Number(this.Options.d);if(isNaN(e))throw new Error("Invalid number "+e);return e}}n.AddField("NUM",o);class l{static SanitizeNumber(e,t=0){return null==e?t:(null==e?void 0:e.IsField)?e.GetNumber():isNaN(e)?t:Number(e)}static NotifyReturnToParent(e){for(;["BLO","MA","FOR","FE"].indexOf(e.Parent.Options.T)<0;)e=e.Parent;e.Parent.ReturnWasExecuted()}static NotifyBreakToParent(e){for(;["FOR","FE"].indexOf(e.Parent.Options.T)<0;)e=e.Parent;e.Parent.BreakWasExecuted()}}class h extends i{constructor(e,t){super(e,t),this.Statement=n.GetFRElement(e.d,this)}Parse(){return l.NotifyReturnToParent(this),this.Statement.Parse()}}n.AddField("RE",h);class c extends i{constructor(e,t){super(e,t),this.Left=n.GetFRElement(e.L,this),this.Right=n.GetFRElement(e.R,this),this.Subtype=e.St}Parse(){return this.MaybeExecutePromise(this.Left.Parse(),(e=>this.MaybeExecutePromise(this.Right.Parse(),(t=>{var r,s;switch(this.Subtype){case"Or":return 1==e||1==t;case"And":return 1==e&&1==t;case"Add":return e=(null===(r=e)||void 0===r?void 0:r.IsField)?"string"==typeof t?e.GetText():e.GetNumber():""==e.toString().trim()||isNaN(Number(e))?e.toString():Number(e),t=(null===(s=t)||void 0===s?void 0:s.IsField)?"string"==typeof e?t.GetText():t.GetNumber():""==t.toString().trim()||isNaN(Number(t))?t.toString():Number(t),e+t;case"Sub":return this.ToNumber(e)-this.ToNumber(t);case"Mult":return this.ToNumber(e)*this.ToNumber(t);case"Div":return 0==(t=this.ToNumber(t))?0:this.ToNumber(e)/t;case"Eq":return this.ToScalar(e)==this.ToScalar(t);case"NEq":return this.ToScalar(e)!=this.ToScalar(t);case"Gt":return this.ToScalar(e)>this.ToScalar(t);case"Gte":return this.ToScalar(e)>=this.ToScalar(t);case"Lt":return this.ToScalar(e)<this.ToScalar(t);case"Lte":return this.ToScalar(e)<=this.ToScalar(t)}}))))}ToScalar(e){return Array.isArray(e)?e.reduce(((e,t)=>e+this.ToScalar(t)),0):(null==e?void 0:e.IsField)?e.GetText():e}ToNumber(e){var t;return Array.isArray(e)?e.reduce(((e,t)=>e+this.ToNumber(t)),0):(null===(t=e)||void 0===t?void 0:t.IsField)?e.GetNumber():(e=Number(e),isNaN(e)?0:e)}}n.AddField("BE",c);class d extends i{constructor(e,t){super(e,t),this.Id=this.Options.Id}Parse(){return this.Retriever.GetFieldById(this.Id)}}n.AddField("RNF",d);class F extends i{constructor(e,t){super(e,t),this.Sentence=n.GetFRElement(this.Options.d,this)}Parse(){return this.Sentence.Parse()}}n.AddField("PE",F);class m extends i{constructor(e,t){super(e,t)}Parse(){return null}}n.AddField("Null",m);class P extends i{constructor(e,t){super(e,t)}Parse(){return this.Options.d.toString()}}n.AddField("STR",P);class p extends i{constructor(e,t){super(e,t),this.Items=[],e.d.forEach((e=>{this.Items.push(n.GetFRElement(e,this))}))}Parse(){let e=[];return this.Iterate(this.Items,((t,r,s)=>{e.push(t)}),(()=>e))}}n.AddField("ARR",p);class x extends i{constructor(e,t){super(e,t),this.Cond=n.GetFRElement(e.C,this),this.Tr=n.GetFRElement(e.Tr,this),this.Fa=n.GetFRElement(e.Fa,this)}Parse(){return this.MaybeExecutePromise(this.Cond.Parse(),(e=>e?this.MaybeExecutePromise(this.Tr.Parse(),(e=>e)):this.MaybeExecutePromise(this.Fa.Parse(),(e=>e))))}}n.AddField("CE",x);class R extends i{constructor(e,t){super(e,t)}Parse(){return this.Options.d}}n.AddField("BL",R);class E extends i{constructor(e,t){super(e,t),this.Subt=this.Options.St,"Pr"==this.Options.St?this.Prop=this.Options.Pr:this.Prop=n.GetFRElement(this.Options.Pr,this),this.Caller=n.GetFRElement(this.Options.C,this),this.Args=[],Array.isArray(this.Options.Args)&&this.Options.Args.forEach((e=>this.Args.push(n.GetFRElement(e,this))))}Parse(){return this.MaybeExecutePromise(this.Caller.Parse(),(e=>{switch(this.Subt){case"Pr":let t=String(this.Prop);if(null==e[t])return null;if(!(t in e))return null;if("function"==typeof e[t]){let r=[];return this.Iterate(this.Args,(e=>r.push(e)),(()=>e[t].apply(e,r)))}return e[t];case"Arr":return this.MaybeExecutePromise(this.Prop.Parse(),(t=>null==t?null:Array.isArray(e)&&null!=e[t]?e[t]:null))}}))}Assign(e){return this.MaybeExecutePromise(this.Caller.Parse(),(t=>{switch(this.Subt){case"Arr":let r=this.Prop.Parse(),s=l.SanitizeNumber(r,null);if(null==s)return null;if(!Array.isArray(t)||t.length<s)return null;t[s]=e;break;case"Pr":if(this.Args.length>0)return;let i=String(this.Prop);return i in t?"function"!=typeof t[i]?t[i]=e:void 0:null}}))}}n.AddField("ME",E);class y{constructor(){this.VarDictionary=new Map,this.VarDictionary.set("Math",Math),this.FunctionDictionary=y.GlobalFunctions}SetVar(e,t){this.VarDictionary.set(e,t)}GetVar(e){return this.VarDictionary.has(e)?this.VarDictionary.get(e):null}AddFunction(e,t){this.FunctionDictionary.set(e,t)}CallFunction(e,t){return this.FunctionDictionary.has(e)?(t=[this,...t],this.FunctionDictionary.get(e).apply(null,t)):null}}y.GlobalFunctions=new Map;class S extends i{constructor(e,t){super(e,t),this.Asignee=n.GetFRElement(this.Options.As,this),this.Value=n.GetFRElement(this.Options.D,this)}Parse(){return this.MaybeExecutePromise(this.Value.Parse(),(e=>{if("VAR"!=this.Asignee.Type)return this.MaybeExecutePromise(this.Asignee.Assign(e),(()=>{}));this.Asignee.Assign(e)}))}}n.AddField("AE",S);class A extends i{constructor(e,t){super(e,t),this.Name=this.Options.d}Parse(){return this.Retriever.GetVar(this.Name)}Assign(e){this.Retriever.SetVar(this.Name,e)}}n.AddField("VAR",A);class b extends i{constructor(e,t){super(e,t),this.Subtype=e.St,this.Expression=n.GetFRElement(this.Options.d,this)}Parse(){return this.MaybeExecutePromise(this.Expression.Parse(),(e=>"-"==this.Options.St?-1*e:!e))}}n.AddField("UE",b);class f extends i{constructor(e,t){super(e,t),this.FunctionName=this.Options.Fn,this.Args=[],this.Options.Ar.forEach((e=>this.Args.push(n.GetFRElement(e,this))))}Parse(){let e=[];return this.Iterate(this.Args,(t=>{e.push(t)}),(()=>this.Retriever.CallFunction(this.FunctionName,e)))}}n.AddField("FC",f);class N extends i{constructor(e,t){super(e,t),this.Condition=n.GetFRElement(this.Options.Con,this),this.TrueAction=n.GetFRElement(this.Options.Tr,this),null!=this.Options.Fa&&(this.FalseAction=n.GetFRElement(this.Options.Fa,this))}Parse(){return this.MaybeExecutePromise(this.Condition.Parse(),(e=>e?this.MaybeExecutePromise(this.TrueAction.Parse(),(e=>e)):null!=this.FalseAction?this.MaybeExecutePromise(this.FalseAction.Parse(),(e=>e)):void 0))}}n.AddField("IF",N);class T extends i{constructor(e,t){super(e,t),this.ShouldReturn=!1,this.Sentences=[],this.Options.d.forEach((e=>this.Sentences.push(n.GetFRElement(e,this))))}Parse(){let e=null;return this.Iterate(this.Sentences,((t,r,s)=>{e=t,this.ShouldReturn&&s()}),(()=>e))}ReturnWasExecuted(){this.ShouldReturn=!0,l.NotifyReturnToParent(this)}}n.AddField("BLO",T);class g extends i{constructor(e,t){super(e,t),this.ShouldBreak=!1,this.Var=n.GetFRElement(e.V,this),null!=e.C&&(this.Cond=n.GetFRElement(e.C,this)),null!=e.I&&(this.Inc=n.GetFRElement(e.I,this)),this.Statement=n.GetFRElement(e.S,this)}Parse(){return this.ShouldBreak=!1,this.MaybeExecutePromise(this.Var.Parse(),(()=>{let e=null;if(null==this.Cond)return e;let t=()=>this.MaybeExecutePromise(this.Cond.Parse(),(r=>r?this.MaybeExecutePromise(this.Statement.Parse(),(r=>(e=r,this.ShouldBreak?e:null!=this.Inc?this.MaybeExecutePromise(this.Inc.Parse(),(()=>t())):t()))):e));return t()}))}ReturnWasExecuted(){this.ShouldBreak=!0,l.NotifyReturnToParent(this)}BreakWasExecuted(){this.ShouldBreak=!0}}n.AddField("FOR",g);class G extends i{constructor(e,t){super(e,t)}Parse(){l.NotifyBreakToParent(this)}}n.AddField("BR",G);class M extends i{constructor(e,t){super(e,t),this.Value="",this.Key="",this.ShouldBreak=!1,this.Expression=n.GetFRElement(e.E,this),this.Value=e.V,this.Key=e.K,this.Statement=n.GetFRElement(e.D,this)}Parse(){return this.MaybeExecutePromise(this.Expression.Parse(),(e=>{let t=[];if(Array.isArray(e))t=Array.from(e.keys());else for(let r in e)t.push(r);let r=null,s=(i=0)=>{if(i>=t.length)return r;let n=t[i],a=e[n];return this.Retriever.SetVar(this.Value,a),""!=this.Key&&this.Retriever.SetVar(this.Key,n),this.MaybeExecutePromise(this.Statement.Parse(),(e=>(r=e,this.ShouldBreak?r:s(i+1))))};return s(0)}))}ReturnWasExecuted(){this.ShouldBreak=!0,l.NotifyReturnToParent(this)}BreakWasExecuted(){this.ShouldBreak=!0}}n.AddField("FE",M);class C extends y{constructor(e,t,r=null){super(),this.Container=e,this.FieldContainer,this.CustomRetriever=r}GetFieldById(e){return this.Container.GetFieldById(e,!0,!0)}GetFixedValue(e,t){if(null!=this.CustomRetriever){let r=this.CustomRetriever(this,e,t);if(null!==r)return r}return this.Container.ParseFixedField(e,t,this.FieldContainer)}}class O extends s.CalculatorBase{ExecuteCalculation(e,t){return{Quantity:0,RegularPrice:0}}async ExecuteAndUpdate(e=!1,t=!1,r=null){return!this.GetIsUsed()&&this.Field.IsPriceField?this.Field.Calculator.UpdatePrice(0):this.Field.FormulaManager.ExecuteFormulaIfExist("Price",null),!0}}t.EventManager.Subscribe("GetCalculator",(e=>{if("formula"==e)return new O}));class v extends i{constructor(e,t){super(e,t),this.Id=this.Options.Id}Parse(){var e;return this.Retriever.GetFixedValue(this.Id,null===(e=this.Options)||void 0===e?void 0:e.Op)}}n.AddField("RNFX",v),exports.FRFixed=v,exports.FRMain=u,exports.FRNumber=o,exports.Return=h,exports.FRBinaryExpression=c,exports.FRField=d,exports.ParenthezisedExpression=F,exports.FRNull=m,exports.FRString=P,exports.FRArray=p,exports.FRCondE=x,exports.FRBool=R,exports.FRCondE=x,exports.FRMembE=E,exports.FRDataRetriever=y,exports.FRAssigmentExpression=S,exports.FRVariable=A,exports.UnaryExpression=b,exports.FRFCExpression=f,exports.FRIfStatement=N,exports.FRBlock=T,exports.FRFor=g,exports.FRBreak=G,exports.FRForE=M,exports.FormulaCalculator=O,t.EventManager.Subscribe("CalculateFormula",(e=>{if(null==e.Formula.Compiled)return;let t=new u(e.Formula.Compiled,new C(e.Owner,e.Field,e.CustomRetriever),e.ExecutionChain);try{switch(e.PreferredReturnType||e.Formula.PreferredReturnType){case r.PreferredReturnTypeEnum.String:return t.ParseString();case r.PreferredReturnTypeEnum.Number:return t.ParseNumber();case r.PreferredReturnTypeEnum.Price:return t.ParsePrice();case r.PreferredReturnTypeEnum.Raw:return t.ParseRaw();default:return t.Parse()}}catch(e){return}}))}));
